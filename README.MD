# Документация по проекту "Система мониторинга температуры и влажности на складах"

## Версия 0.5.0 (Refactored Edition)

## Описание

Данный проект представляет собой систему мониторинга температуры и влажности на складах. Он использует протокол Modbus для взаимодействия с датчиками и предоставляет API для получения текущих и исторических данных.

### Последние улучшения (v0.5.0)

- **Оптимизация производительности**: Снижение нагрузки на I/O, CPU, память.
- **Устранение утечек памяти**: Использование LRU cache с автоматической очисткой.
- **Gzip компрессия**: Уменьшение сетевого трафика.
- **Streaming для больших файлов**: Поддержка архивов любого размера без блокировки.
- **Health check endpoint**: Мониторинг состояния приложения `/api/health`.
- **Улучшенный UI**: Debounce, lazy loading графиков, оптимизация Chart.js.
- **Модульная архитектура**: Разделение на сервисы (Metrics, State, FileStorage).

## Структура проекта

**src/**: Исходный код приложения
- **api/**: Содержит маршруты API и middleware
  - **routes/**: Определяет маршруты для получения данных (с LRU cache)
  - **middleware/**: Middleware компоненты (rateLimiter, compression)
- **services/**: Сервисные модули (новое в v0.5.0)
  - **MetricsService.js**: Управление метриками приложения
  - **StateService.js**: Централизованное управление состоянием
- **storage/**: Логика для сохранения данных в архив
  - **archive.js**: Архивация и сжатие старых файлов
  - **FileStorage.js**: Абстракция хранилища с streaming (новое)
- **utils/**: Утилиты для обработки данных и логирования
  - **dataConverter.js**: Функции для декодирования данных Modbus
  - **date.js**: Функции для работы с датой и временем
  - **logger.js**: Оптимизированное логирование
- **server.js**: Главный файл для запуска сервера (с gzip и лимитами)

**config/**: Конфигурационные файлы
- **default.json**: Основная конфигурация (расширенная с Modbus, API, cache настройками)
- **test.json**: Конфигурация для тестового окружения

**PUBLIC/**: Клиентская часть приложения
- **js/**: JavaScript файлы
  - **lib/**: Сторонние библиотеки (Chart.js, Day.js)
  - **app.js**: Основной файл приложения (с debounce и lazy loading)
  - **chart-utils.js**: Утилиты для работы с графиками
  - **constants.js**: Константы и пределы значений
  - **data-service.js**: Сервис для работы с API
  - **modal-history.js**: Компонент модального окна для исторических данных
  - **ui-components.js**: Компоненты интерфейса
  - **utils.js**: Утилиты (debounce, throttle, lazy observers) - новое
  - **error-handler.js**: Централизованная обработка ошибок - новое
- **styles.css**: Адаптивные стили приложения
- **index.html**: Главная страница
- **metrics.html**: Страница мониторинга метрик

**test/**: Тестовое окружение
- **run-mock.js**: Скрипт для запуска тестового окружения с мок-сервером

**archive/**: Папка для хранения архивных данных
**node_modules/**: Папка с установленными зависимостями
**.env**: Файл с переменными окружения (LOG_LEVEL, PORT)
**package.json**: Файл с зависимостями и скриптами проекта

## Используемые JS модули:
- [Chart.js](https://www.chartjs.org/)
- [Day.js](https://day.js.org/) - заменил Moment.js для уменьшения размера сборки на 96%
- [Chart.js Day.js Adapter](https://github.com/bolstycjw/chartjs-adapter-dayjs-4) - кастомный адаптер для Chart.js v4

## Уровни логирования

Система поддерживает следующие уровни логирования:
- **ERROR (0)**: Критические ошибки, нарушающие работу приложения
- **WARN (1)**: Предупреждения, не нарушающие работу, но требующие внимания
- **INFO (2)**: Информационные сообщения о важных событиях (по умолчанию)
- **DEBUG (3)**: Подробная отладочная информация

Для запуска с нужным уровнем логирования можно использовать один из следующих способов:
- В Windows: `set LOG_LEVEL=DEBUG && node src/server.js`
- В Linux/Mac: `LOG_LEVEL=DEBUG node src/server.js`
- С npm: `cross-env LOG_LEVEL=DEBUG node src/server.js`
- Также можно установить переменную окружения в файле `.env`

## Установка и запуск из исходных файлов
(для разрешения на выполнение некоторых скриптов под виндовс возможно потребуется выполнить "Set-ExecutionPolicy RemoteSigned -Scope Process")

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/ViktorAgafonov/NodeModBus
   ```

2. Перейдите в директорию проекта:
   ```bash
   cd NodeModBus
   ```

3. Установите зависимости:
   ```bash
   npm install
   ```

4. Настройте конфигурацию:
   - Основная конфигурация находится в `config/default.json`
   - Тестовая конфигурация в `config/test.json`
   - Настройки логирования и порт в `.env`

5. Запустите приложение с автоматической перезагрузкой при изменении кода:
   ```bash
   npm start
   ```

   Для разработки и тестирования с эмулятором modbus сервера:
   ```bash
   npm test
   ```

## Тестирование

Команда `npm test` запускает мок-сервер Modbus TCP, который возвращает фиксированные тестовые значения:
- Температура: 20°C (регистры 2250-2251)
- Влажность: 50% (регистры 2200-2201)

## Установка и запуск посредством docker-compose

- Запустить контейнер c рабочей версией
    ``` bash
    ./docker-compose.prod.sh
    ```
- Запустить docker контейнер с эмулятором (или запустить run_test_docker.cmd)
    ``` bash
    NODE_CMD=test docker-compose up
    ```
- Проверить работоспособность сервисов: 
    ``` bash
    docker-compose logs -f server
    docker-compose logs -f emulator
    ```
- Удалить все созданные контейнеры и образы:
    ``` bash
    docker-compose down --volumes --remove-orphans
    docker rmi nodemodbus
    ```

## Если требуется внесение изменений в docker-compose:
- Остановить контейнеры: 
    ``` bash
    docker-compose down
    ```
- Пересобрать образ:
    ``` bash 
    docker-compose build
    ```
- Запустить заново: 
    ``` bash
    docker-compose up -d
    ```

## Используемые NODE модули:
- **express** - основной веб-фреймворк
- **compression** - gzip компрессия ответов (новое в v0.5.0)
- **modbus-serial** - для работы с Modbus
- **dayjs** - для работы с датами (заменил moment.js для уменьшения размера)
- **config** - для гибких конфигураций
- **archiver** - используется в archive.js для сжатия в zip
- **express-rate-limit** - используется в rateLimiter.js для ограничений количества запросов к API
- **lru-cache** - LRU кэш с автоматической очисткой (новое в v0.5.0)
- **JSONStream** - потоковый парсинг больших JSON файлов (новое в v0.5.0)
- **nodemon** - для автоперезапуска сервера при разработке (при npm start)
- **cross-env** - для установки переменных окружения кросс-платформенно

## API Endpoints

### Ограничения запросов

Для обеспечения стабильной работы сервера установлены следующие ограничения:
- Общий лимит: 60 запросов в минуту для всех API endpoints
- Исторические данные: 30 запросов в минуту

При превышении лимита сервер вернет статус 429 (Too Many Requests) и сообщение об ошибке.

### GET /api/current
Возвращает текущие данные о температуре и влажности.

**Пример ответа:**
```json
{
    "temperature": [
        {
            "timestamp": "2024-12-12 00:00:00",
            "value": -13.2,
            "sensor_id": "storage_1.temperature_1",
            "type": "temperature",
            "error": false
        }
    ],
    "humidity": [
        {
            "timestamp": "2024-12-12 00:00:00",
            "value": 0.5,
            "sensor_id": "storage_1.humidity_1",
            "type": "humidity",
            "error": false
        }
    ]
}
```

### GET /api/history
Возвращает исторические данные. Поддерживает следующие параметры запроса:
- `range`: Временной диапазон (1h, 24h, 14d, 60d)

**Интервалы агрегации данных:**
- 1h: 5 минут
- 24h: 1 час
- 14d: 12 часов
- 60d: 24 часа

**Пример запроса:**
```
GET /api/history?range=24h
```

### GET /api/storage/:storageId/history
Возвращает исторические данные для конкретного склада. Поддерживает те же параметры, что и `/api/history`.

**Пример запроса:**
```
GET /api/storage/storage_1/history?range=24h
```

### GET /api/config
Возвращает конфигурацию системы.

### GET /api/health (новое в v0.5.0)
Возвращает статус здоровья приложения для мониторинга.

**Пример ответа:**
```json
{
    "status": "ok",
    "timestamp": "2025-01-16T10:00:00.000Z",
    "uptime": 12345,
    "memory": {
        "used": 85,
        "total": 128
    }
}
```

### GET /api/metrics
Возвращает JSON с метриками системы (ошибки, производительность, использование ресурсов).

### GET /metrics
Возвращает HTML страницу с интерфейсом для просмотра метрик.

### POST /api/metrics/reset
Сбрасывает все метрики системы и очищает текущие данные датчиков.

## Конфигурация

### Структура config.json (обновлено в v0.5.0)

```json
{
    "settings": {
        "polling": {
            "modbus": 5000,    // Интервал опроса датчиков (мс)
            "archive": 60000   // Интервал архивации данных (мс)
        },
        "modbus": {
            "connectTimeout": 1000,        // Таймаут подключения
            "minPollDelay": 500,           // Минимальная задержка между опросами
            "readTimeout": 250,            // Таймаут чтения
            "readRetries": 2,              // Количество повторов
            "retryDelay": 100,             // Задержка между повторами
            "significantChange": 0.001,    // Порог логирования изменений
            "defaultSensorAddress": 2,     // Адрес датчика по умолчанию
            "defaultRegisterCount": 2      // Количество регистров
        },
        "api": {
            "logTimeout": 6000,            // Таймаут логирования API запросов
            "requestLimit": "5mb"          // Лимит размера запроса
        },
        "cache": {
            "diskUsageTimeout": 300000,    // Таймаут кэша размера диска (5 мин)
            "historyTtl": 60000,           // TTL кэша истории (1 мин)
            "maxSize": 100                 // Максимальный размер LRU кэша
        },
        "limits": {
            "differentLimit": 0.001,       // Разница для определения старых данных
            "fixedValue": 3                // Округление значений датчиков
        }
    },
    "storages": [
        {
            "name": "Склад 1",
            "device": {
                "ip": "127.0.0.1",
                "port": 502,
                "sensors": [
                    {
                        "name": "Темпер. 1",
                        "type": "temperature",
                        "register": 2250,
                        "address": 2
                    }
                ]
            }
        }
    ]
}
```

### Поля конфигурации датчиков:

- **name**: Отображаемое имя датчика в интерфейсе
- **type**: *(Обязательное)* Тип датчика (temperature/humidity)
  - Используется для группировки в UI
  - Фильтрация в API
  - Проверка лимитов значений
- **register**: *(Обязательное)* Адрес регистра Modbus
- **count**: *(Опциональное)* Количество регистров для чтения (по умолчанию: 2)
- **address**: *(Опциональное)* ID устройства Modbus (по умолчанию: 1)

### Пределы значений

#### Температура
- Минимум: -40°C *Для приборов OWEN ПВТ110 RS485*
- Максимум: 80°C *Для приборов OWEN ПВТ110 RS485*
- Предупреждение: -15°C

#### Влажность
- Минимум: 0%
- Максимум: 100%
- Предупреждение: 30%

## Оборудование

### Шлюзы
МКОН преобразователь протокола Modbus TCP/IP (ОВЕН):
- Преобразование протоколов Modbus RTU/ASCII и Modbus TCP
- Интерфейсы: RS-485 и Ethernet/Wi-Fi

### Датчики
Датчик температуры и влажности ПВТ110 RS485 (ОВЕН):
- Цифровой сигнал по протоколу Modbus (RTU) через RS-485
- Диапазоны измерения:
  - Температура: -40...80°C
  - Влажность: 0...100% RH
- Особенности:
  - Гальваническая развязка между питанием и RS-485
  - Степень защиты IP65
  - Межповерочный интервал – 12 месяцев

## Архивация данных

Данные сохраняются в JSON-файлы в директории `archive/` с именем в формате `YYYY-MM-DD.json`. Каждый файл содержит массив измерений за соответствующие сутки.

### Формат архивных данных:
```json
[
    {
        "timestamp": "2025-02-22 12:00:00",
        "sensors": [
            {
                "sensor_id": "storage_1.temperature_1",
                "type": "temperature",
                "value": 23.5
            }
        ]
    }
]
```

## Логирование

Система использует многоуровневое логирование:
- ERROR: Критические ошибки
- WARN: Предупреждения
- INFO: Информационные сообщения
- DEBUG: Отладочная информация

Логи включают:
- Подключение/отключение к устройствам Modbus
- Ошибки чтения датчиков
- Существенные изменения значений
- Операции с архивными файлами

## Веб-интерфейс

Веб-интерфейс предоставляет следующие возможности:
- Отображение текущих данных температуры и влажности для всех складов
- Графики изменения показаний датчиков в реальном времени
- Просмотр исторических данных в различных временных диапазонах
- Индикация статуса подключения к складам
- Предупреждения о выходе показаний за допустимые пределы
- Адаптивный дизайн для различных устройств

### Временные диапазоны для графиков:
- 1 час (шаг 5 минут)
- 24 часа (шаг 1 час)
- 2 недели (шаг 12 часов)
- 2 месяца (шаг 1 день)
