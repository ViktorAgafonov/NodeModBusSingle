#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –æ–±—Ä–∞–∑–∞
if [ -f "nodemodbus.tar" ]; then
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑ –∏–∑ —Ñ–∞–π–ª–∞
    echo "–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞ –∏–∑ —Ñ–∞–π–ª–∞..."
    docker load < nodemodbus.tar
    
    if [ $? -eq 0 ]; then
        echo "–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
        docker-compose up -d
        
        if [ $? -eq 0 ]; then
            echo "–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏..."
            # –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
            sleep 5
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
            response=$(curl -s -w "%{http_code}" http://localhost:3000/api/current -o /dev/null)
            
            if [ "$response" == "200" ]; then
                echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ—Ä—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ 3000"
                echo "üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:3000/metrics.html"
                echo "üì¢ –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∏—Å—Ç–µ–º—ã - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: docker-compose down"
                echo "üìÑ –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: docker logs nodemodbus"
            else
                echo "‚ùå –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞, –Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã"
                echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker logs nodemodbus"
                exit 1
            fi
        else
            echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
            exit 1
        fi
    else
        echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—Ä–∞–∑–∞"
        exit 1
    fi
else
    echo "–û—à–∏–±–∫–∞: —Ñ–∞–π–ª nodemodbus.tar –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å:"
    echo "- nodemodbus.tar"
    echo "- docker-compose.yml"
    echo "–ï—Å–ª–∏ —Ñ–∞–π–ª–∞ .tar –Ω–µ—Ç - –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É 'docker pull vvagafonov/nodemodbus:latest' –∞ –∑–∞—Ç–µ–º 'docker save nodemodbus:latest > nodemodbus.tar'"
    echo "–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ ;) "
    exit 1
fi